<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Result</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script>
        function showPredictionSection() {
            document.getElementById('prediction-section').style.display = 'block';
        }
    </script>
    <script>
        function showPredictiongraph() {
            document.getElementById('prediction-graph').style.display = 'block';
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const predictionForm = document.getElementById('prediction-form');
            if (predictionForm) {
                predictionForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(predictionForm);
                    
                    fetch('/predict', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update the stats display
                            const statsTarget = document.getElementById('stats-target');
                            statsTarget.innerHTML = `
                                <p>Current Balance: ${data.current_balance}</p>
                                <p>Predicted Balance (in ${data.days} days): ${data.predicted_balance}</p>
                            `;
                            
                            // Build the forecast table
                            const tableContainer = document.getElementById('forecast-table-container');
                            let tableHTML = `
                                <h4 class="mt-4">Forecast Table</h4>
                                <table class="table table-striped table-bordered">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Date</th>
                                            <th>ARIMA Prediction</th>
                                            <th>LSTM Prediction</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            data.prediction_data.forEach(row => {
                                const date = new Date(row.Date).toLocaleDateString();
                                const arimaPred = `‚Çπ${row.ARIMA_Prediction.toFixed(2)}`;
                                const lstmPred = `‚Çπ${row.LSTM_Prediction.toFixed(2)}`;
                                tableHTML += `
                                    <tr>
                                        <td>${date}</td>
                                        <td>${arimaPred}</td>
                                        <td>${lstmPred}</td>
                                    </tr>
                                `;
                            });
                            tableHTML += '</tbody></table>';
                            tableContainer.innerHTML = tableHTML;
                            
                            // Show the prediction graph
                            showPredictiongraph();

                            // Show the prediction graph section and budget button
                            document.getElementById('prediction-graph').style.display = 'block';
                            const budgetBtn = document.getElementById('generate-budget-btn');
                            budgetBtn.style.display = 'inline-block';

                            // Add click listener for the budget button
                            budgetBtn.addEventListener('click', function() {
                                const budgetDetails = document.getElementById('budget-details');
                                const budgetData = data.budget_data;

                                function buildTable(title, data) {
                                    if (!data) return '';
                                    let table = `<h5 class="mt-4">${title}</h5><table class="table table-sm table-bordered"><tbody>`;
                                    for (const [key, value] of Object.entries(data)) {
                                        table += `<tr><td>${key}</td><td>‚Çπ${value.toFixed(2)}</td></tr>`;
                                    }
                                    table += '</tbody></table>';
                                    return table;
                                }

                                let budgetHTML = `
                                    <h4 class="mt-3">AI-Based Budget Suggestion for Next Month</h4>
                                    <ul class="list-group">
                                        <li class="list-group-item"><strong>Predicted Income:</strong> ‚Çπ${budgetData.predicted_income.toFixed(2)}</li>
                                        <li class="list-group-item"><strong>Predicted Expenses:</strong> ‚Çπ${budgetData.predicted_expense.toFixed(2)}</li>
                                        <li class="list-group-item"><strong>Recommended Savings (${(budgetData.savings_ratio * 100).toFixed(0)}%):</strong> ‚Çπ${budgetData.dynamic_savings.toFixed(2)}</li>
                                        <li class="list-group-item"><strong>Essential Expenses (70%):</strong> ‚Çπ${budgetData.essential_expense.toFixed(2)}</li>
                                        <li class="list-group-item"><strong>Non-Essential Expenses (30%):</strong> ‚Çπ${budgetData.non_essential_expense.toFixed(2)}</li>
                                    </ul>
                                `;
                                
                                budgetHTML += buildTable('Expense Breakdown by Category (Excluding Transfers)', budgetData.category_expense);
                                budgetHTML += buildTable('Adaptive Budget Allocation Based on Past Trends', budgetData.adaptive_allocation);

                                if (budgetData.over_spending) {
                                    budgetHTML += `<div class="alert alert-warning mt-3"><h5>‚ö†Ô∏è Overspending Alert</h5>` +
                                                  buildTable('You are predicted to overspend in these categories:', budgetData.over_spending) +
                                                  `</div>`;
                                }

                                if (budgetData.income_warning) {
                                    budgetHTML += `<div class="alert alert-danger mt-3">${budgetData.income_warning}</div>`;
                                }

                                budgetDetails.innerHTML = budgetHTML;

                                // Update graph sources with a cache-busting query string
                                const timestamp = new Date().getTime();
                                document.getElementById('budget-graph1').src = `{{ url_for('static', filename='graph10.png') }}?t=${timestamp}`;
                                document.getElementById('budget-graph2').src = `{{ url_for('static', filename='graph11.png') }}?t=${timestamp}`;

                                // Show the budget section
                                document.getElementById('budget-section').style.display = 'block';
                            }, { once: true });
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while processing the prediction.');
                    });
                });
            }
        });
    </script>
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center">Analysis Completed</h2>
        <p class="text-center">Your file <strong>{{ filename }}</strong> has been processed.</p>

        <!-- Display Extracted Transactions -->
        <h3 class="mt-4">Extracted Transactions</h3>
        <div class="table-responsive">
            {{ table_html | safe }}
        </div>

        <!-- Display Graphs -->
        <h3 class="mt-4">Analysis Charts</h3>
        <div class="text-center">
            <img src="{{ url_for('static', filename='graph1.png') }}" class="img-fluid">
            <img src="{{ url_for('static', filename='graph2.png') }}" class="img-fluid">
            <img src="{{ url_for('static', filename='graph3.png') }}" class="img-fluid">
            <img src="{{ url_for('static', filename='graph4.png') }}" class="img-fluid">
            <img src="{{ url_for('static', filename='graph5.png') }}" class="img-fluid">
            <img src="{{ url_for('static', filename='graph6.png') }}" class="img-fluid">
            <img src="{{ url_for('static', filename='graph7.png') }}" class="img-fluid">
            <img src="{{ url_for('static', filename='graph8.png') }}" class="img-fluid">
            <img src="{{ url_for('static', filename='graph9.png') }}" class="img-fluid">
            <br>
            <button type="button" class="btn btn-primary" onclick="showPredictionSection()">Predict Your Balance</button>
        </div>
        
        <!-- Prediction Section -->
        <div id="prediction-section" style="display: none;">
            <br>
            <form action="/predict" method="post" id="prediction-form">
                <input type="number" name="days" placeholder="Enter the number of days you want to predict the balance" class="form-control mb-3" min="1" max="365" value="30">
                <button type="submit" class="btn btn-primary">Predict</button>
            </form>
            <br>
        </div>
        
        <div id="prediction-graph" style="display: none;">
            <div id="stats-target">
                <!-- Prediction results will be loaded here -->
            </div>
            <h3>Prediction Analysis Charts</h3>
            <div id="forecast-table-container" class="table-responsive mt-3">
                <!-- Forecast table will be injected here -->
            </div>
            <div class="text-center mt-4">
                <button type="button" id="generate-budget-btn" class="btn btn-success" style="display: none;">üí∏ Generate Budget Suggestion</button>
            </div>
        </div>
        
        <div id="budget-section" style="display: none;">
            <h3 class="mt-4">AI-Based Budget Suggestion</h3>
            <div id="budget-details" class="mt-3">
                <!-- Budget details will be injected here -->
            </div>
            <h3 class="mt-4">Budget Charts</h3>
            <div class="text-center mt-3">
                <img id="budget-graph1" src="" class="img-fluid" alt="Expense Breakdown">
                <img id="budget-graph2" src="" class="img-fluid" alt="Budget Allocation">
            </div>
        </div>

        <div id="budget-stats">
                
        </div>

        <div class="text-center mt-3">
            <a href="/" class="btn btn-secondary">Upload Another File</a>
        </div>
    </div>
</body>
</html>
